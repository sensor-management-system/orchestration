stages:
  - build
  - backup
  - deploy

variables:
  GIT_SUBMODULE_STRATEGY: recursive

cache:
  paths:
    - frontend/dist

.docker_login_gitlab_registry: &docker_login_gitlab_registry
  - echo "$CI_BUILD_TOKEN" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY

.docker_build:
  image: docker:20.10.7
  services:
    - docker:20.10.7-dind
  before_script:
    - *docker_login_gitlab_registry
  tags:
    - docker

build-deploy-image-nginx-gfz-staging:
  stage: build
  extends: .docker_build
  variables:
    CLIENT_ID: ${GFZ_STAGING_OIDC_CLIENT_ID}
  script:
    - |
        docker build --tag "$CI_REGISTRY_IMAGE/nginx:gfz-latest" -f docker/build/nginx/gfz/staging/Dockerfile \
          --build-arg CLIENT_ID_ARG=$CLIENT_ID \
          .
    - docker push "$CI_REGISTRY_IMAGE/nginx:gfz-latest"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - frontend/node_modules
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
    

build-deploy-image-nginx-gfz-prod:
  stage: build
  extends: .docker_build
  variables:
    CLIENT_ID: ${GFZ_PROD_OIDC_CLIENT_ID}
  script:
    - |
        docker build --tag "$CI_REGISTRY_IMAGE/nginx:gfz-${CI_COMMIT_TAG:-latest}" -f docker/build/nginx/gfz/prod/Dockerfile \
          --build-arg CLIENT_ID_ARG=$CLIENT_ID \
          .
    - docker push "$CI_REGISTRY_IMAGE/nginx:gfz-${CI_COMMIT_TAG:-latest}"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - frontend/node_modules
  rules:
    - if: '$CI_COMMIT_TAG != null && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'

build-deploy-image-vocabulary-gfz-staging:
  stage: build
  extends: .docker_build
  script:
    - |
        docker build --tag "$CI_REGISTRY_IMAGE/vocabulary:gfz-latest" -f sms-cv/docker/gfz/deployment/Dockerfile \
          sms-cv
    - docker push "$CI_REGISTRY_IMAGE/vocabulary:gfz-latest"
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
    

build-deploy-image-vocabulary-gfz-prod:
  stage: build
  extends: .docker_build
  script:
    - |
        docker build --tag "$CI_REGISTRY_IMAGE/vocabulary:gfz-${CI_COMMIT_TAG:-latest}" -f sms-cv/docker/gfz/deployment/Dockerfile \
          sms-cv
    - docker push "$CI_REGISTRY_IMAGE/vocabulary:gfz-${CI_COMMIT_TAG:-latest}"
  rules:
    - if: '$CI_COMMIT_TAG != null && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'

build-deploy-image-backend-gfz-staging:
  stage: build
  extends: .docker_build
  script:
    - |
        docker build --tag "$CI_REGISTRY_IMAGE/backend:gfz-latest" -f backend/Dockerfile \
          backend
    - docker push "$CI_REGISTRY_IMAGE/backend:gfz-latest"
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
    

build-deploy-image-backend-gfz-prod:
  stage: build
  extends: .docker_build
  script:
    - |
        docker build --tag "$CI_REGISTRY_IMAGE/backend:gfz-${CI_COMMIT_TAG:-latest}" -f backend/Dockerfile \
          backend
    - docker push "$CI_REGISTRY_IMAGE/backend:gfz-${CI_COMMIT_TAG:-latest}"
  rules:
    - if: '$CI_COMMIT_TAG != null && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'

backup-gfz-staging:
  stage: backup
  environment:
    name: gfz-staging
    url: https://rz-vm64.gfz-potsdam.de
  tags:
    - deploy
    - staging
    - gfz
    - shell
  variables:
    COMPOSE_PROJECT_NAME: sms-staging
    VOCABULARY_SECRET_KEY: ${GFZ_STAGING_VOCABULARY_SECRET}
    VOCABULARY_DB_USER: ${GFZ_STAGING_VOCABULARY_POSTGRES_USER}
    VOCABULARY_DB_PASSWORD: ${GFZ_STAGING_VOCABULARY_POSTGRES_PASSWORD}
    MINIO_ROOT_USER: ${GFZ_STAGING_MINIO_ROOT_USER}
    MINIO_ROOT_PASSWORD: ${GFZ_STAGING_MINIO_ROOT_PASSWORD}
    BACKEND_DB_USER: ${GFZ_STAGING_BACKEND_POSTGRES_USER}
    BACKEND_DB_PASSWORD: ${GFZ_STAGING_BACKEND_POSTGRES_PASSWORD}
    BACKEND_SECRET_KEY: ${GFZ_STAGING_BACKEND_SECRET}
    OIDC_CLIENT_ID: ${GFZ_STAGING_OIDC_CLIENT_ID}
  before_script:
    # clean up & remove files older than 180 days
    - find /srv/docker/service/backend-db/backups -type f -mtime +180 -exec rm {} \;
    - find /srv/docker/service/vocabulary-db/backups -type f -mtime +180 -exec rm {} \;
  script:
    - docker-compose -f docker/deployment/gfz/staging/docker-compose.yml exec -T vocabulary-db pg_dump -U $VOCABULARY_DB_USER -d vocabulary | gzip > /srv/docker/service/vocabulary-db/backups/vocabulary_$(date +%Y%m%d-%H%M)_${CI_COMMIT_SHORT_SHA}.sql.gz
    - docker-compose -f docker/deployment/gfz/staging/docker-compose.yml exec -T backend-db pg_dump -U $BACKEND_DB_USER -d backend | gzip > /srv/docker/service/backend-db/backups/backend_$(date +%Y%m%d-%H%M)_${CI_COMMIT_SHORT_SHA}.sql.gz
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'

backup-gfz-prod:
  stage: backup
  environment:
    name: gfz-prod
    url: https://sensors.gfz-potsdam.de
  tags:
    - deploy
    - prod
    - gfz
    - shell
  variables:
    COMPOSE_PROJECT_NAME: sms-prod
    VOCABULARY_SECRET_KEY: ${GFZ_PROD_VOCABULARY_SECRET}
    VOCABULARY_DB_USER: ${GFZ_PROD_VOCABULARY_POSTGRES_USER}
    VOCABULARY_DB_PASSWORD: ${GFZ_PROD_VOCABULARY_POSTGRES_PASSWORD}
    MINIO_ROOT_USER: ${GFZ_PROD_MINIO_ROOT_USER}
    MINIO_ROOT_PASSWORD: ${GFZ_PROD_MINIO_ROOT_PASSWORD}
    BACKEND_DB_USER: ${GFZ_PROD_BACKEND_POSTGRES_USER}
    BACKEND_DB_PASSWORD: ${GFZ_PROD_BACKEND_POSTGRES_PASSWORD}
    BACKEND_SECRET_KEY: ${GFZ_PROD_BACKEND_SECRET}
    OIDC_CLIENT_ID: ${GFZ_PROD_OIDC_CLIENT_ID}
  before_script:
    # clean up & remove files older than 180 days
    - find /srv/docker/service/backend-db/backups -type f -mtime +180 -exec rm {} \;
    - find /srv/docker/service/vocabulary-db/backups -type f -mtime +180 -exec rm {} \;
  script:
    - docker-compose -f docker/deployment/gfz/prod/docker-compose.yml exec -T vocabulary-db pg_dump -U $VOCABULARY_DB_USER -d vocabulary | gzip > /srv/docker/service/vocabulary-db/backups/vocabulary_$(date +%Y%m%d-%H%M)_${CI_COMMIT_SHORT_SHA}.sql.gz
    - docker-compose -f docker/deployment/gfz/prod/docker-compose.yml exec -T backend-db pg_dump -U $BACKEND_DB_USER -d backend | gzip > /srv/docker/service/backend-db/backups/backend_$(date +%Y%m%d-%H%M)_${CI_COMMIT_SHORT_SHA}.sql.gz
  rules:
    - if: '$CI_COMMIT_TAG != null && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

deploy-gfz-staging:
  stage: deploy
  environment:
    name: gfz-staging
    url: https://rz-vm64.gfz-potsdam.de
  tags:
    - deploy
    - staging
    - gfz
    - shell
  variables:
    COMPOSE_PROJECT_NAME: sms-staging
    VOCABULARY_SECRET_KEY: ${GFZ_STAGING_VOCABULARY_SECRET}
    VOCABULARY_DB_USER: ${GFZ_STAGING_VOCABULARY_POSTGRES_USER}
    VOCABULARY_DB_PASSWORD: ${GFZ_STAGING_VOCABULARY_POSTGRES_PASSWORD}
    MINIO_ROOT_USER: ${GFZ_STAGING_MINIO_ROOT_USER}
    MINIO_ROOT_PASSWORD: ${GFZ_STAGING_MINIO_ROOT_PASSWORD}
    BACKEND_DB_USER: ${GFZ_STAGING_BACKEND_POSTGRES_USER}
    BACKEND_DB_PASSWORD: ${GFZ_STAGING_BACKEND_POSTGRES_PASSWORD}
    BACKEND_SECRET_KEY: ${GFZ_STAGING_BACKEND_SECRET}
    OIDC_CLIENT_ID: ${GFZ_STAGING_OIDC_CLIENT_ID}
  before_script:
    - *docker_login_gitlab_registry
  script:
    - docker-compose -f docker/deployment/gfz/staging/docker-compose.yml down --remove-orphans
    - docker-compose -f docker/deployment/gfz/staging/docker-compose.yml rm -f
    - docker-compose -f docker/deployment/gfz/staging/docker-compose.yml pull
    - docker-compose -f docker/deployment/gfz/staging/docker-compose.yml up -d
    - docker-compose -f docker/deployment/gfz/staging/docker-compose.yml exec -T vocabulary python3 manage.py migrate
    - docker-compose -f docker/deployment/gfz/staging/docker-compose.yml exec -T vocabulary python3 manage.py loaddata initial_data.json
    - docker-compose -f docker/deployment/gfz/staging/docker-compose.yml exec -T vocabulary python3 manage.py loaddata default_community_data.json
    - docker-compose -f docker/deployment/gfz/staging/docker-compose.yml exec -T vocabulary python3 manage.py loaddata hydro_community_data.json
    - docker-compose -f docker/deployment/gfz/staging/docker-compose.yml exec -T vocabulary python3 manage.py collectstatic --no-input
    - docker-compose -f docker/deployment/gfz/staging/docker-compose.yml exec -T backend python3 manage.py db upgrade
    - sleep 1m
    - docker-compose -f docker/deployment/gfz/staging/docker-compose.yml exec -T backend python3 manage.py es reindex
    - docker rmi $(docker images -q -f dangling=true) || true
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'

deploy-gfz-prod:
  stage: deploy
  environment:
    name: gfz-prod
    url: https://sensors.gfz-potsdam.de
  tags:
    - deploy
    - prod
    - gfz
    - shell
  variables:
    COMPOSE_PROJECT_NAME: sms-prod
    VOCABULARY_SECRET_KEY: ${GFZ_PROD_VOCABULARY_SECRET}
    VOCABULARY_DB_USER: ${GFZ_PROD_VOCABULARY_POSTGRES_USER}
    VOCABULARY_DB_PASSWORD: ${GFZ_PROD_VOCABULARY_POSTGRES_PASSWORD}
    MINIO_ROOT_USER: ${GFZ_PROD_MINIO_ROOT_USER}
    MINIO_ROOT_PASSWORD: ${GFZ_PROD_MINIO_ROOT_PASSWORD}
    BACKEND_DB_USER: ${GFZ_PROD_BACKEND_POSTGRES_USER}
    BACKEND_DB_PASSWORD: ${GFZ_PROD_BACKEND_POSTGRES_PASSWORD}
    BACKEND_SECRET_KEY: ${GFZ_PROD_BACKEND_SECRET}
    OIDC_CLIENT_ID: ${GFZ_PROD_OIDC_CLIENT_ID}
  before_script:
    - *docker_login_gitlab_registry
  script:
    - docker-compose -f docker/deployment/gfz/prod/docker-compose.yml down --remove-orphans
    - docker-compose -f docker/deployment/gfz/prod/docker-compose.yml rm -f
    - docker-compose -f docker/deployment/gfz/prod/docker-compose.yml pull
    - docker-compose -f docker/deployment/gfz/prod/docker-compose.yml up -d
    - docker-compose -f docker/deployment/gfz/prod/docker-compose.yml exec -T vocabulary python3 manage.py migrate
    - docker-compose -f docker/deployment/gfz/prod/docker-compose.yml exec -T vocabulary python3 manage.py loaddata initial_data.json
    - docker-compose -f docker/deployment/gfz/prod/docker-compose.yml exec -T vocabulary python3 manage.py loaddata default_community_data.json
    - docker-compose -f docker/deployment/gfz/prod/docker-compose.yml exec -T vocabulary python3 manage.py loaddata hydro_community_data.json
    - docker-compose -f docker/deployment/gfz/prod/docker-compose.yml exec -T vocabulary python3 manage.py collectstatic --no-input
    - docker-compose -f docker/deployment/gfz/prod/docker-compose.yml exec -T backend python3 manage.py db upgrade
    - sleep 1m
    - docker-compose -f docker/deployment/gfz/prod/docker-compose.yml exec -T backend python3 manage.py es reindex
    - docker rmi $(docker images -q -f dangling=true) || true
  rules:
    - if: '$CI_COMMIT_TAG != null && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE != "schedule"'
