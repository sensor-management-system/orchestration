# Web client of the Sensor Management System software developed within
# the Helmholtz DataHub Initiative by GFZ and UFZ.
# 
# Copyright (C) 2020-2021
# - Nils Brinckmann (GFZ, nils.brinckmann@gfz-potsdam.de)
# - Marc Hanisch (GFZ, marc.hanisch@gfz-potsdam.de)
# - Helmholtz Centre Potsdam - GFZ German Research Centre for
#   Geosciences (GFZ, https://www.gfz-potsdam.de)
# 
# Parts of this program were developed within the context of the
# following publicly funded projects or measures:
# - Helmholtz Earth and Environment DataHub
#   (https://www.helmholtz.de/en/research/earth_and_environment/initiatives/#h51095)
# 
# Licensed under the HEESIL, Version 1.0 or - as soon they will be 
# approved by the "Community" - subsequent versions of the HEESIL 
# (the "Licence").
# 
# You may not use this work except in compliance with the Licence.
# 
# You may obtain a copy of the Licence at: 
# https://gitext.gfz-potsdam.de/software/heesil
# 
# Unless required by applicable law or agreed to in writing, software 
# distributed under the Licence is distributed on an "AS IS" basis, 
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or 
# implied. See the Licence for the specific language governing 
# permissions and limitations under the Licence.
version : '3.3'

services:
  nginx:
    image: ${CI_REGISTRY_IMAGE}/nginx:gfz-${CI_COMMIT_TAG:-prod-test}
    restart: unless-stopped
    ports:
      - 80:80
      - 443:443
      - 8443:8443
    volumes:
      - /etc/ssl/gfz_hosts_default.chained.crt:/etc/ssl/default.crt:ro
      - /etc/ssl/private/gfz_hosts_default.key:/etc/ssl/private/default.key:ro
      - /etc/ssl/dhparam.pem:/etc/ssl/dhparam.pem:ro
      - /etc/ssl/dfn-ca-global-g2-chain.pem:/etc/ssl/chain.pem:ro
      - vocabulary-static-files:/usr/share/nginx/html/static:ro
    networks:
      - nginx

  vocabulary:
      image: ${CI_REGISTRY_IMAGE}/vocabulary:gfz-${CI_COMMIT_TAG:-prod-test}
    restart: unless-stopped
    environment:
      CV_BASE_URL: cv/
      DEBUG: 0
      SECRET_KEY: $VOCABULARY_SECRET_KEY
      SQL_ENGINE: django.db.backends.postgresql_psycopg2
      SQL_DATABASE: vocabulary
      SQL_USER: $VOCABULARY_DB_USER
      SQL_PASSWORD: $VOCABULARY_DB_PASSWORD
      SQL_HOST: vocabulary-db
      SQL_PORT: 5432
      CORS_ORIGIN_WHITELIST: 'https://localhost,https://sensors.gfz-potsdam.de'
    volumes:
      - vocabulary-static-files:/usr/cv/app/static
    networks:
      - nginx
      - vocabulary-db

  vocabulary-db:
    image: postgres:12-alpine
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: $VOCABULARY_DB_PASSWORD
      POSTGRES_USER: $VOCABULARY_DB_USER
      POSTGRES_DB: vocabulary
    volumes:
      - "vocabulary-db-data:/var/lib/postgresql/data"
    shm_size: 128M
    networks:
      - vocabulary-db

volumes:
  vocabulary-db-data:
  vocabulary-static-files:
networks:
  vocabulary-db:
  nginx:
  vocabulary-db:
    image: postgres:12-alpine
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: $VOCABULARY_DB_PASSWORD
      POSTGRES_USER: $VOCABULARY_DB_USER
      POSTGRES_DB: vocabulary
    volumes:
      - "vocabulary-db-data:/var/lib/postgresql/data"
    shm_size: 128M
    networks:
      - vocabulary-db

volumes:
  vocabulary-db-data:
  vocabulary-static-files:
networks:
  vocabulary-db:
  nginx:
