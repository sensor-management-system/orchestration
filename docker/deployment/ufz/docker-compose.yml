version: '3.8'
services:

  app:
    image: registry.hzdr.de/hub-terra/sms/backend:latest
    restart: unless-stopped
    ports:
      - "${PORT:-5000}:5000"
    env_file:
      - ./${ENVIRONMENT}/app.env
    networks:
      - sms

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.13.2
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - cluster.routing.allocation.disk.threshold_enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - esdata01:/usr/share/elasticsearch/data

  minio1:
    image: minio/minio:RELEASE.2021-08-05T22-01-19Z
    restart: unless-stopped
    volumes:
      - minio-data:/data/minio
    ports:
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY}
    command: server /data/minio --console-address ":9001"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - sms

  createbuckets:
    image: minio/mc:latest
    depends_on:
      - minio1
    networks:
      - sms
    # Make a Bucket using minio client mc
    # https://docs.min.io/docs/minio-client-complete-guid
    entrypoint: >
      /bin/sh -c "
      until curl -f http://minio1:9000/minio/health/live; do sleep 5; done;
      /usr/bin/mc  alias set minio http://minio1:9000 \"${MINIO_ACCESS_KEY}\" \"${MINIO_SECRET_KEY}\" --api S3v4;
      /usr/bin/mc mb --quiet minio/${MINIO_BUCKET_NAME};
      /usr/bin/mc policy set download minio/${MINIO_BUCKET_NAME};
      exit 0;
      "

volumes:
  esdata01:
    driver: local
  minio-data:
networks:
  sms:
    external: true
    name: sms