{% extends "base_sensorml_template.xml" %}

        {% block description %}{{super()}}{% endblock %}

        {% block identifiers %}{{super()}}{% endblock %}

        {% block classifiers %}
        {% if obj.device_type_name %}
        <!-- ========================================================================= -->
        <!-- ========================================================================= -->
        <sml:classification>
            <sml:ClassifierList>
                <sml:classifier>
                    <sml:Term definition="http://sensorml.com/ont/swe/property/SensorType">
                        <sml:label>sensor type</sml:label>
                        <sml:value>{{obj.device_type_name}}</sml:value>
                    </sml:Term>
                </sml:classifier>
            </sml:ClassifierList>
        </sml:classification>
        {% endif %}
        {% endblock %}

        {% block documentation %}
        {% if obj.device_attachments or obj.website %}
        <!-- ========================================================================= -->
        <!--                 Documentation                                             -->
        <!-- ========================================================================= -->
        <sml:documentation>
            <sml:DocumentList>
                {% if obj.device_attachments %}
                {% for attachment in obj.device_attachments %}
                <sml:document xlink:arcrole="Attachment">
                    <gmd:CI_OnlineResource id="Attachment_{{attachment.id}}_of_PhysicalSystem_{{gmlId}}">
                        <gmd:linkage>
                            <gmd:URL>{{attachment.url}}</gmd:URL>
                        </gmd:linkage>
                        <gmd:name>
                            <gco:CharacterString>{{attachment.label}}</gco:CharacterString>
                        </gmd:name>
                    </gmd:CI_OnlineResource>
                </sml:document>
                {% endfor %}
                {% endif %}
                {% if obj.website %}
                <sml:document xlink:arcrole="Website">
                    <gmd:CI_OnlineResource>
                        <gmd:linkage>
                            <gmd:URL>{{obj.website}}</gmd:URL>
                        </gmd:linkage>
                    </gmd:CI_OnlineResource>
                </sml:document>
                {% endif %}
            </sml:DocumentList>
        </sml:documentation>
        {% endif %}
        {% endblock %}
        
        {% block outputs %}
        {% if obj.device_properties  %}
        <!-- ========================================================================= -->
        <!--                 Outputs = Quantities                                      -->
        <!-- ========================================================================= -->
<sml:outputs>
    <sml:OutputList>
        {% for property in obj.device_properties %}
        <sml:output name='{{property.property_name | replace(" ", "_")}}'>
          {% if property.property_uri %}
          <swe:Quantity definition="{{property.property_uri or ''}}">
          {% else %}
          <swe:Quantity>
          {% endif %}
              <swe:label>{{property.label or ""}}</swe:label>
              {% if property.unit_name %}
              <swe:uom code="{{property.unit_name}}"/>
              {% else %}
              <swe:uom />
              {% endif %}
          </swe:Quantity>
        </sml:output>
        {% endfor %}
    </sml:OutputList>
</sml:outputs>

        {% endif %}
        {% endblock %}

        {% block history %}
        <!-- ========================================================================= -->
        <!--                 History                                                   -->
        <!-- ========================================================================= -->
{% if obj.device_mount_actions or obj.device_calibration_actions or obj.generic_device_actions or obj.device_software_update_actions %}        
<sml:history>
    <sml:EventList>

    {% block mount_actions %}
    {% for action in obj.device_mount_actions %}
    <!-- ========================================================================= -->
    <!--                 Mount action   id:{{action.id}}                           -->
    <!-- ========================================================================= -->
    <sml:event>
        <sml:Event>
            <sml:classification>
                <sml:ClassifierList>
                    <sml:classifier>
                        <sml:Term definition="Mount">
                            {% if action.configuration.label %}
                            <sml:label>Mounted to {{action.configuration.label}}</sml:label>
                            {% else %}
                            <sml:label>Mounted to configuration {{action.configuration.id}}</sml:label>
                            {% endif %}
                            <sml:value>Mount</sml:value>
                        </sml:Term>
                    </sml:classifier>
                </sml:ClassifierList>
            </sml:classification>
            <sml:time>
                <gml:TimePeriod gml:id="TimePeriodForDeviceMountAction_{{action.id}}_of_{{gmlId}}">
                    <gml:description>{{action.begin_description or ""}}</gml:description>
                    <gml:begin>
                        <gml:TimeInstant>
                            <gml:timePosition>{{action.begin_date.isoformat()}}</gml:timePosition>
                        </gml:TimeInstant>
                    </gml:begin>
                    <gml:end>
                        {% if action.end_date %}
                        <gml:TimeInstant>
                            <gml:timePosition>{{action.end_date.isoformat()}}</gml:timePosition>
                        </gml:TimeInstant>
                        {% endif %}
                    </gml:end>
                </gml:TimePeriod>
            </sml:time>
        </sml:Event>
    </sml:event>
    {% endfor %}
    {% endblock %}


    {% block device_calibration_actions %}
    {% for action in obj.device_calibration_actions %}

    <!-- ========================================================================= -->
    <!--                 Calibration actions   id:{{action.id}}                    -->
    <!-- ========================================================================= -->
    <sml:event>
        <sml:Event>
            <sml:classification>
                <sml:ClassifierList>
                    <sml:classifier>
                        <sml:Term definition="Calibration">
                            <sml:label>Calibration</sml:label>
                            <sml:value>{{action.value or ""}}</sml:value>
                        </sml:Term>
                    </sml:classifier>
                </sml:ClassifierList>
            </sml:classification>
            <sml:time>
                <gml:TimeInstant gml:id="TimeInstantForCalibration_{{action.id}}_of_{{gmlId}}">
                  <gml:timePosition>{{action.current_calibration_date.isoformat()}}</gml:timePosition>
                </gml:TimeInstant>
            </sml:time>
            {# TODO Find a valid way to put the formula & description in; + think about next calibration date #}
        </sml:Event>
    </sml:event>
    {% endfor %}
    {% endblock %}

    {% block generic_actions %}
    {% for action in obj.generic_device_actions %}
    <!-- ========================================================================= -->
    <!--           Generic actions: {{action.action_type_name}} id:{{action.id}}   -->
    <!-- ========================================================================= -->

    <sml:event>
        <sml:Event>
            <sml:classification>
                <sml:ClassifierList>
                    <sml:classifier>
                      <sml:Term
                          definition="{{action.action_type_uri or 'Action'}}"
                      >
                            <sml:label>{{action.action_type_name}}</sml:label>
                            <sml:value>{{action.action_type_name}}</sml:value>
                        </sml:Term>
                    </sml:classifier>
                </sml:ClassifierList>
            </sml:classification>
            <sml:time>
                <gml:TimePeriod
                        gml:id="TimePeriodFor{{action.action_type_name.replace(' ', '')}}_{{action.id}}_of_{{gmlId}}">
                    <gml:description>{{action.description or ""}}</gml:description>
                    <gml:begin>
                        <gml:TimeInstant>
                            <gml:timePosition>{{action.begin_date.isoformat()}}</gml:timePosition>
                        </gml:TimeInstant>
                    </gml:begin>
                    <gml:end>
                        {% if action.end_date %}
                        <gml:TimeInstant>
                            <gml:timePosition>{{action.end_date.isoformat()}}</gml:timePosition>
                        </gml:TimeInstant>
                        {% endif %}
                    </gml:end>
                </gml:TimePeriod>
            </sml:time>
        </sml:Event>
    </sml:event>
    {% endfor %}
    {% endblock %}

    {% block software_update_actions %}
    {% for action in obj.device_software_update_actions %}
    <!-- ========================================================================= -->
    <!--                 Software Update actions   id:{{action.id}}                -->
    <!-- ========================================================================= -->

    <sml:event>
        <sml:Event>
            <sml:classification>
                <sml:ClassifierList>
                    <sml:classifier>
                        <sml:Term definition="{{action.software_type_uri or 'SoftwareUpdate'}}">
                            <sml:label>{{action.software_type_name}}</sml:label>
                            <sml:value>{{action.software_type_name}}</sml:value>
                        </sml:Term>
                    </sml:classifier>
                </sml:ClassifierList>
            </sml:classification>
            <sml:time>
                <gml:TimeInstant
                  gml:id="TimeInstantFor{{action.software_type_name.replace(' ', '')}}Update_{{action.id}}_of_{{gmlId}}"
                >
                  <gml:timePosition>{{action.update_date.isoformat()}}</gml:timePosition>
                </gml:TimeInstant>
            </sml:time>
        </sml:Event>
    </sml:event>

    {% endfor %}

    {% endblock %}

</sml:EventList>
</sml:history>
{% endif %}
{% endblock %}
